#!/usr/bin/env pwsh
# Install WSL and arch linux

$ErrorActionPreference = "Stop"

Write-Host "Starting WSL and arch linux installation..." -ForegroundColor Green

try {
    # Check if arch linux distribution is already installed
    $archInstalled = $false
    try {
        $distributions = wsl --list --quiet 2>$null
        $archInstalled = $distributions | Where-Object { $_.Trim() -eq "arch" }
    } catch {
        # WSL not installed, will install it with the distribution
    }

    if (-not $archInstalled) {
        wsl --install -d archlinux --name arch --no-launch
        
        # Initialize pacman keyring and update system
        wsl -d arch -- pacman-key --init
        wsl -d arch -- pacman-key --populate archlinux
        wsl -d arch -- pacman -Syu --noconfirm
        
        # Install sudo and zsh
        wsl -d arch -- pacman -S --noconfirm sudo zsh
        
        # Setup users after installation
        $username = $env:USERNAME.ToLower()
        
        # Create user with same name as Windows user (using default shell first)
        wsl -d arch -- useradd -m -G wheel $username
        
        # Set default user to the created user
        wsl -d arch -u root -- sh -c "echo -e '[user]\\ndefault=$username' > /etc/wsl.conf"

        # Set wsl to use systemd
        wsl -d arch -u root -- sh -c "echo -e '[boot]\\nsystemd=true' >> /etc/wsl.conf"
        
        # Enable wheel group for passwordless sudo
        wsl -d arch -u root -- sh -c "echo '%wheel ALL=(ALL:ALL) NOPASSWD: ALL' >> /etc/sudoers"
        
        # Change user shell to zsh
        wsl -d arch -u root -- usermod -s /bin/zsh $username
        
        # Terminate WSL to apply configuration changes
        wsl --terminate arch
    }

}
catch {
    Write-Error "Error during WSL/arch installation: $_"
} 

Write-Host "WSL and arch linux installation completed." -ForegroundColor Green