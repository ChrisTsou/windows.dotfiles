#!/usr/bin/env pwsh
# Install WSL and arch linux

$ErrorActionPreference = "Stop"

Write-Host "Starting WSL and arch linux installation..." -ForegroundColor Green

try {
    # Check if arch linux distribution is already installed
    $archInstalled = $false
    try {
        $distributions = wsl --list --quiet 2>$null
        $archInstalled = $distributions | Where-Object { $_.Trim() -eq "arch" }
    } catch {
        # WSL not installed, will install it with the distribution
    }

    if (-not $archInstalled) {
        wsl --install -d archlinux --name arch
        
        # Setup users after installation
        $username = $env:USERNAME.ToLower()
        
        # Initialize pacman keyring and update system
        wsl -d arch -- pacman-key --init
        wsl -d arch -- pacman-key --populate archlinux
        wsl -d arch -- pacman -Syu --noconfirm
        
        # Install sudo and zsh
        wsl -d arch -- pacman -S --noconfirm sudo zsh
        
        # Create user with same name as Windows user
        wsl -d arch -- useradd -m -G wheel -s /bin/zsh $username
        
        # Set default user to the created user
        wsl -d arch -- /bin/bash -c "echo -e '[user]\ndefault=$username' > /etc/wsl.conf"
        
        # Enable wheel group for passwordless sudo
        wsl -d arch -- /bin/bash -c "echo '%wheel ALL=(ALL:ALL) NOPASSWD: ALL' >> /etc/sudoers"
    }

}
catch {
    Write-Error "Error during WSL/arch installation: $_"
} 

Write-Host "WSL and arch linux installation completed." -ForegroundColor Green